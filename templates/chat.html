<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HealthBridge Assistant</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css')}}" />
  </head>
  <body>
    <main class="app-shell">
      <section class="chat-panel">
        <header class="chat-header">
          <div class="avatar">
            <img
              src="https://cdn-icons-png.flaticon.com/512/387/387569.png"
              alt="HealthBridge Assistant"
            />
            <span class="status-dot" aria-hidden="true"></span>
          </div>
          <div>
            <h1>HealthBridge Assistant</h1>
            <p>Your personal medical research companion</p>
          </div>
        </header>

        <div id="messageList" class="message-list" role="log" aria-live="polite"></div>

        <div class="suggestions" id="suggestionList" aria-label="Suggested prompts">
          <button type="button" data-suggestion="What are the symptoms of anemia?">Symptoms of anemia</button>
          <button type="button" data-suggestion="How can I improve my sleep hygiene?">Improve sleep hygiene</button>
          <button type="button" data-suggestion="Explain the recommended diet for managing diabetes.">Diet for diabetes</button>
        </div>

        <div class="typing-indicator" id="typingIndicator" hidden>
          <span></span>
          <span></span>
          <span></span>
          <p>HealthBridge is formulating a responseâ€¦</p>
        </div>

        <form id="messageForm" class="message-form" autocomplete="off">
          <label class="sr-only" for="userMessage">Type your message</label>
          <textarea
            id="userMessage"
            name="msg"
            placeholder="Ask a medical question or describe your symptoms..."
            rows="1"
            required
          ></textarea>
          <button type="submit" id="sendButton" aria-label="Send message">
            <span>Send</span>
          </button>
        </form>
      </section>
    </main>

    <template id="messageTemplate">
      <div class="message" data-role="">
        <div class="message-meta">
          <span class="message-author"></span>
          <time class="message-time"></time>
        </div>
        <div class="message-bubble"></div>
      </div>
    </template>

    <script>
      const form = document.getElementById("messageForm");
      const messageInput = document.getElementById("userMessage");
      const messageList = document.getElementById("messageList");
      const typingIndicator = document.getElementById("typingIndicator");
      const suggestionList = document.getElementById("suggestionList");
      const messageTemplate = document.getElementById("messageTemplate");

      const sessionKey = "healthbridge-session";
      let sessionId = localStorage.getItem(sessionKey);
      if (!sessionId) {
        sessionId = crypto.randomUUID();
        localStorage.setItem(sessionKey, sessionId);
      }

      const sendButton = document.getElementById("sendButton");

      const setButtonState = (state) => {
        sendButton.disabled = state;
        sendButton.classList.toggle("is-loading", state);
      };

      const autoResize = (target) => {
        target.style.height = "auto";
        target.style.height = `${Math.min(target.scrollHeight, 160)}px`;
      };

      const createMessage = (role, text, allowHtml = false) => {
        const element = messageTemplate.content.firstElementChild.cloneNode(true);
        element.dataset.role = role;
        element.querySelector(".message-author").textContent =
          role === "user" ? "You" : "HealthBridge";
        element.querySelector(".message-time").textContent = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
        const bubble = element.querySelector(".message-bubble");
        if (allowHtml) {
          bubble.innerHTML = text;
        } else {
          bubble.textContent = text;
        }
        return element;
      };

      const appendMessage = (role, text, options = {}) => {
        const message = createMessage(role, text, options.allowHtml);
        messageList.appendChild(message);
        messageList.scrollTo({ top: messageList.scrollHeight, behavior: "smooth" });
      };

      const toggleTypingIndicator = (isVisible) => {
        typingIndicator.hidden = !isVisible;
        typingIndicator.classList.toggle("visible", isVisible);
      };

      messageInput.addEventListener("input", (event) => {
        autoResize(event.target);
        setButtonState(!event.target.value.trim());
      });

      suggestionList.addEventListener("click", (event) => {
        const suggestion = event.target.dataset?.suggestion;
        if (!suggestion) return;
        messageInput.value = suggestion;
        autoResize(messageInput);
        setButtonState(false);
        messageInput.focus();
      });

      const sendMessage = async (text) => {
        appendMessage("user", text);
        toggleTypingIndicator(true);

        try {
          const response = await fetch("/get", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ msg: text, session_id: sessionId }),
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "Unable to get a response");
          }

          appendMessage("assistant", data.answer.trim());
        } catch (error) {
          appendMessage(
            "assistant",
            `I ran into an issue processing that request. Please try again.\n\nDetails: ${error.message}`
          );
        } finally {
          toggleTypingIndicator(false);
        }
      };

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const text = messageInput.value.trim();
        if (!text) return;

        setButtonState(true);
        messageInput.value = "";
        autoResize(messageInput);

        sendMessage(text).finally(() => {
          setButtonState(false);
        });
      });

      // Prime the interface with a welcome message
      appendMessage(
        "assistant",
        "Hello! I'm HealthBridge, your companion for navigating medical information. How can I support you today?"
      );

      setButtonState(true);
    </script>
  </body>
</html>
